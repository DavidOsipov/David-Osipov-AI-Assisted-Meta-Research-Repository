# SPDX-License-Identifier: GPL-3.0-or-later
# SPDX-FileCopyrightText: Copyright Â© 2025 David Osipov  <personal@david-osipov.vision> (ORCID: 0009-0005-2713-9242, ISNI: 0000 0005 1802 960X)
# SPDXID: SPDXRef-File--dot-github-workflows-sbom-generator-yml
# FileType: SOURCE
#
# FileName: .github/workflows/sbom-generator.yml
# FileComment: Example GitHub Actions workflow for CI/CD or other automation for the meta-research repository.
# LicenseComments: Workflow configuration licensed under GPL-3.0-or-later.
name: Generate SBOM

on:
  workflow_dispatch: # Allows manual triggering
  push:
    branches:
      - main # Or your default branch name

permissions:
  contents: write # Needed to commit back to the repository
  pull-requests: write # Needed to create the PR

jobs:
  generate-sbom:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@85e6279cec87321a52edac9c87bce653a07cf6c2

      - name: Set up Python
        uses: actions/setup-python@e348410e00f449ece8581cb8e88be8f0e7712da6
        with:
          python-version: '3.13'
          cache: 'pip'
          cache-dependency-path: requirements.txt

      - name: Cache apt packages
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684
        with:
          path: /var/cache/apt/archives
          key: ${{ runner.os }}-apt-libmagic-${{ hashFiles('.github/workflows/sbom-generator.yml') }} # Key based on OS and this workflow file
          restore-keys: |
            ${{ runner.os }}-apt-libmagic-

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y libmagic-dev jq

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install sbom4files

      - name: Generate SBOM
        run: |
          sbom4files -d . -p "${{ github.repository }}" -r -i pyc,py,pyi --sbom spdx --format json -o sbom.spdx
          echo "SBOM generation completed."

      - name: Filter out .git directory and self from SBOM
        run: |
          # Use map/select to rebuild the array, keeping only valid file objects that don't match the patterns
          jq '.files |= map(select(type == "object" and has("fileName") and (.fileName | startswith("./.git/") | not) and (.fileName != "./sbom.spdx")))' sbom.spdx > sbom_filtered.spdx
          # Check if filtering was successful before moving
          if [ $? -eq 0 ]; then
            mv sbom_filtered.spdx sbom.spdx
            echo "Successfully filtered SBOM."
          else
            echo "Error filtering SBOM. Check sbom.spdx and the jq command."
            exit 1
          fi

      - name: Create Pull Request # Replaces the git-auto-commit-action
        uses: peter-evans/create-pull-request@271a8d0340265f705b14b6d32b9829c1cb33d45e
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'Update SBOM' # Quoted to avoid YAML parsing issues
          committer: 'SBOM Generator <noreply@github.com>' # Quoted
          author: '${{ github.actor }} <${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com>' # Quoted
          signoff: false
          branch: 'update-sbom' # Quoted for consistency
          delete-branch: true # Delete the branch once the PR is merged/closed
          title: 'Update SBOM' # Quoted
          body: |
            Automated SBOM update via GitHub Actions.

            This PR updates the `sbom.spdx` file.
          assignees: ${{ github.actor }}
          # reviewers: # Optional: Add reviewers
          # team-reviewers: # Optional: Add team reviewers
          # milestone: # Optional: Assign a milestone
          # draft: false # Set to true to create a draft PR
